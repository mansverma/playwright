version: 2.1

# Define executors
executors:
  playwright-executor:
    docker:
      - image: mcr.microsoft.com/playwright:v1.55.0-jammy
    working_directory: ~/project
    environment:
      NODE_ENV: test
      CI: true

# Reusable commands
commands:
  install_dependencies:
    description: "Install Node.js dependencies"
    steps:
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}

  run_script:
    description: "Run npm script"
    parameters:
      script:
        type: string
    steps:
      - run:
          name: Run npm script << parameters.script >>
          command: npm run << parameters.script >>

# Jobs
jobs:
  test-all:
    executor: playwright-executor
    steps:
      - checkout
      - install_dependencies
      - run_script:
          script: test:ci
      - store_artifacts:
          path: playwright-report/
          destination: playwright-report
      - store_artifacts:
          path: test-results/
          destination: test-results
      - store_test_results:
          path: test-results/

  test-desktop:
    executor: playwright-executor
    steps:
      - checkout
      - install_dependencies
      - run_script:
          script: test:desktop
      - store_artifacts:
          path: playwright-report/
          destination: playwright-report-desktop
      - store_artifacts:
          path: test-results/
          destination: test-results-desktop

  test-mobile:
    executor: playwright-executor
    steps:
      - checkout
      - install_dependencies
      - run_script:
          script: test:mobile
      - store_artifacts:
          path: playwright-report/
          destination: playwright-report-mobile
      - store_artifacts:
          path: test-results/
          destination: test-results-mobile

# Workflows
workflows:
  version: 2
  test-workflow:
    jobs:
      - test-all:
          filters:
            branches:
              only:
                - main
                - master
      - test-desktop:
          filters:
            branches:
              ignore:
                - main
                - master
      - test-mobile:
          filters:
            branches:
              ignore:
                - main
                - master

  nightly-tests:
    triggers:
      - schedule:
          cron: "0 2 * * *" # 2 AM UTC daily
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - test-all
